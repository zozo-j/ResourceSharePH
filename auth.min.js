class AuthSystem{constructor(){this.currentUser=null,this.users=[]}async hashPassword(e){const t=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("")}async loadUsers(){try{let e=[];if("undefined"!=typeof db&&"function"==typeof db.loadTable){e=(await db.loadTable("users")).map(e=>({ID:e.ID||e.Id||e.id||"",Username:e.Username||e.username||"",PasswordHash:e.PasswordHash||e.PasswordHash||"",Role:e.Role||e.role||"user",FullName:e.FullName||e["Full Name"]||e.fullName||"",Barangay:e.Barangay||e.barangay||"",Phone:e.Phone||e.phone||"",PhoneVerified:"true"===e.PhoneVerified||!0===e.PhoneVerified||!1,DateRegistered:e.DateRegistered||e["Date Registered"]||""}))}const t=localStorage.getItem("registeredUsers"),r=t?JSON.parse(t):[],o={};e.forEach(e=>{e.Username&&(o[e.Username]=e)}),r.forEach(e=>{e.Username&&(o[e.Username]=e)}),this.users=Object.values(o)}catch(e){const t=localStorage.getItem("registeredUsers"),r=t?JSON.parse(t):[];this.users=[...r],console.error("Error loading users from CSV, falling back to localStorage:",e)}}async login(e,t){await this.loadUsers();const r=await this.hashPassword(t);console.log("Login attempt:",e),console.log("Generated hash:",r),console.log("Users loaded:",this.users.length);const o=this.users.find(t=>(console.log("Checking user:",t.Username,"Hash:",t.PasswordHash),t.Username===e&&t.PasswordHash===r));return!!o&&(this.currentUser={id:o.ID,username:o.Username,role:o.Role,fullName:o.FullName,barangay:o.Barangay,phone:o.Phone||"",phoneVerified:o.PhoneVerified||"admin"===o.Role},localStorage.setItem("currentUser",JSON.stringify(this.currentUser)),!0)}logout(){this.currentUser=null,localStorage.removeItem("currentUser"),showLoginForm()}isLoggedIn(){if(!this.currentUser){const e=localStorage.getItem("currentUser");e&&(this.currentUser=JSON.parse(e))}return null!==this.currentUser}getCurrentUser(){return this.currentUser}async updateProfile(e,t,r,o,n){if(!this.currentUser)return!1;await this.loadUsers();const s=await this.hashPassword(o);if(!this.users.find(e=>e.Username===this.currentUser.username&&e.PasswordHash===s))return{success:!1,message:"Current password is incorrect"};const a=this.users.findIndex(e=>e.Username===this.currentUser.username);if(-1!==a){this.users[a].FullName=e,this.users[a].Barangay=t,this.users[a].Phone=r,n&&(this.users[a].PasswordHash=await this.hashPassword(n)),this.currentUser.fullName=e,this.currentUser.barangay=t,this.currentUser.phone=r,localStorage.setItem("currentUser",JSON.stringify(this.currentUser));const o=localStorage.getItem("registeredUsers");if(o){const e=JSON.parse(o),t=e.findIndex(e=>e.Username===this.currentUser.username);-1!==t&&(e[t]=this.users[a],localStorage.setItem("registeredUsers",JSON.stringify(e)))}return"function"==typeof renderUsers&&renderUsers(),{success:!0,message:"Profile updated successfully"}}return{success:!1,message:"Update failed"}}async register(e,t,r,o,n,s){if(this.users.find(t=>t.Username===e))return{success:!1,message:"Username already exists"};const a=await this.hashPassword(t),d={ID:Date.now().toString(),Username:e,PasswordHash:a,Role:s||"user",FullName:r,Barangay:o,Phone:n,PhoneVerified:!0,DateRegistered:(new Date).toLocaleDateString()};this.users.push(d);const i=localStorage.getItem("registeredUsers"),l=i?JSON.parse(i):[];return l.push(d),localStorage.setItem("registeredUsers",JSON.stringify(l)),"undefined"!=typeof appData&&appData.users.push({id:d.ID,username:d.Username,fullName:d.FullName,role:d.Role,barangay:d.Barangay,phone:d.Phone,dateRegistered:d.DateRegistered}),"function"==typeof renderUsers&&renderUsers(),this.appendToUsersCSV(d),{success:!0,message:"Registration successful"}}async appendToUsersCSV(e){try{const t=await fetch("./assets/Users.csv"),r=await t.text(),o=`\n${e.ID},${e.Username},${e.PasswordHash},${e.Role},${e.FullName},${e.Barangay},${e.DateRegistered}`,n=new Blob([r+o],{type:"text/csv"}),s=window.URL.createObjectURL(n),a=document.createElement("a");a.href=s,a.download="Users_Updated.csv",a.click(),window.URL.revokeObjectURL(s),console.log("Updated Users.csv downloaded with new user:",e.Username)}catch(e){console.error("Error updating Users.csv:",e)}}}const auth=new AuthSystem;function showLoginForm(){document.body.innerHTML='\n        <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);">\n            <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 400px;">\n                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">üáµüá≠ ResourceShare PH</h2>\n                <div id="login-form">\n                    <input type="text" id="username" placeholder="Username" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                    <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                    <button onclick="handleLogin()" style="width: 100%; padding: 15px; background: #ff6b6b; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Login</button>\n                    <button onclick="showRegisterForm()" style="width: 100%; padding: 15px; background: #feca57; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Register</button>\n                </div>\n                <div id="register-form" style="display: none;">\n                    <input type="text" id="reg-username" placeholder="Username" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                    <input type="password" id="reg-password" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                    <input type="text" id="reg-fullname" placeholder="Full Name" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                    <input type="text" id="reg-barangay" placeholder="Barangay" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                    <input type="tel" id="reg-phone" placeholder="Phone Number (09xxxxxxxxx)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                    <select id="reg-role" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">\n                        <option value="">Select Role</option>\n                        <option value="user">User</option>\n                        <option value="volunteer">Volunteer</option>\n                    </select>\n                    <button onclick="handleRegister()" style="width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Register</button>\n                    <button onclick="showLoginForm()" style="width: 100%; padding: 15px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">Back to Login</button>\n                </div>\n\n            </div>\n        </div>\n    '}function showRegisterForm(){document.getElementById("login-form").style.display="none",document.getElementById("register-form").style.display="block"}async function handleLogin(){const e=document.getElementById("username").value,t=document.getElementById("password").value;if(!e||!t)return void alert("Please enter username and password");await auth.login(e,t)?location.reload():alert("Invalid username or password")}async function handleRegister(){const e=document.getElementById("reg-username").value,t=document.getElementById("reg-password").value,r=document.getElementById("reg-fullname").value,o=document.getElementById("reg-barangay").value,n=document.getElementById("reg-phone").value,s=document.getElementById("reg-role").value;if(!(e&&t&&r&&o&&n&&s))return void alert("Please fill in all fields");if(!/^09\d{9}$/.test(n))return void alert("Please enter a valid Philippine mobile number (09xxxxxxxxx)");const a=await auth.register(e,t,r,o,n,s);a.success?(alert(a.message+" Please login."),showLoginForm()):alert(a.message)}function addLogoutButton(){const e=document.querySelector("header");if(e&&auth.isLoggedIn()){const t=auth.getCurrentUser();e.innerHTML+=`\n            <div class="profile-dropdown" style="position: absolute; top: 20px; right: 20px;">\n                <button class="profile-icon" onclick="toggleProfileDropdown()">üë§</button>\n                <div class="dropdown-content" id="profileDropdown">\n                    <div style="text-align: center; margin-bottom: 15px; color: #333; padding-bottom: 15px; border-bottom: 1px solid #eee;">\n                        <strong>${t.fullName}</strong><br>\n                        <small>${t.barangay} ‚Ä¢ ${t.role}</small>\n                    </div>\n                    <div class="profile-menu">\n                        <button onclick="showEditProfile()" style="width: 100%; padding: 10px; margin-bottom: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üìù Edit Profile</button>\n                        <button onclick="showChangePassword()" style="width: 100%; padding: 10px; margin-bottom: 8px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üîí Change Password</button>\n                        <button onclick="auth.logout()" style="width: 100%; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üö™ Logout</button>\n                    </div>\n                    <div class="profile-form" id="editProfileForm" style="display: none;">\n                        <h4 style="margin-bottom: 15px; color: #333;">Edit Profile</h4>\n                        <input type="text" id="profile-fullname" placeholder="Full Name" value="${t.fullName}">\n                        <input type="text" id="profile-barangay" placeholder="Barangay" value="${t.barangay}">\n                        <input type="tel" id="profile-phone" placeholder="Phone Number" value="${t.phone||""}">\n                        <input type="password" id="profile-current-password" placeholder="Current Password">\n                        <button onclick="updateProfileInfo()">Update Profile</button>\n                        <button onclick="showProfileMenu()" style="background: #6c757d; margin-top: 5px;">Back</button>\n                    </div>\n                    <div class="profile-form" id="changePasswordForm" style="display: none;">\n                        <h4 style="margin-bottom: 15px; color: #333;">Change Password</h4>\n                        <input type="password" id="password-current" placeholder="Current Password">\n                        <input type="password" id="password-new" placeholder="New Password">\n                        <input type="password" id="password-confirm" placeholder="Confirm New Password">\n                        <button onclick="updatePassword()">Change Password</button>\n                        <button onclick="showProfileMenu()" style="background: #6c757d; margin-top: 5px;">Back</button>\n                    </div>\n                </div>\n            </div>\n        `}}function toggleProfileDropdown(){document.getElementById("profileDropdown").classList.toggle("show"),showProfileMenu()}function showProfileMenu(){document.querySelector(".profile-menu").style.display="block",document.getElementById("editProfileForm").style.display="none",document.getElementById("changePasswordForm").style.display="none"}function showEditProfile(){document.querySelector(".profile-menu").style.display="none",document.getElementById("editProfileForm").style.display="block",document.getElementById("changePasswordForm").style.display="none"}function showChangePassword(){document.querySelector(".profile-menu").style.display="none",document.getElementById("editProfileForm").style.display="none",document.getElementById("changePasswordForm").style.display="block"}async function updateProfileInfo(){const e=document.getElementById("profile-fullname").value,t=document.getElementById("profile-barangay").value,r=document.getElementById("profile-phone").value,o=document.getElementById("profile-current-password").value;if(!e||!t||!o)return void alert("Please fill in all required fields");const n=await auth.updateProfile(e,t,r,o,null);n.success?(alert(n.message),document.getElementById("profile-current-password").value="",document.getElementById("profileDropdown").classList.remove("show"),addLogoutButton()):alert(n.message)}async function updatePassword(){const e=document.getElementById("password-current").value,t=document.getElementById("password-new").value,r=document.getElementById("password-confirm").value;if(!e||!t||!r)return void alert("Please fill in all fields");if(t!==r)return void alert("New passwords do not match");const o=auth.getCurrentUser(),n=await auth.updateProfile(o.fullName,o.barangay,o.phone,e,t);n.success?(alert("Password changed successfully"),document.getElementById("password-current").value="",document.getElementById("password-new").value="",document.getElementById("password-confirm").value="",document.getElementById("profileDropdown").classList.remove("show")):alert(n.message)}async function updateProfile(){const e=document.getElementById("profile-fullname").value,t=document.getElementById("profile-barangay").value,r=document.getElementById("profile-current-password").value,o=document.getElementById("profile-new-password").value,n=document.getElementById("profile-confirm-password").value;if(!e||!t||!r)return void alert("Please fill in all required fields");if(o&&o!==n)return void alert("New passwords do not match");const s=await auth.updateProfile(e,t,r,o);s.success?(alert(s.message),document.getElementById("profile-current-password").value="",document.getElementById("profile-new-password").value="",document.getElementById("profile-confirm-password").value="",document.getElementById("profileDropdown").classList.remove("show"),addLogoutButton()):alert(s.message)}function showAdminElements(){const e=auth.getCurrentUser();if(e&&"admin"===e.role){document.querySelectorAll(".admin-only").forEach(e=>{e.style.display="inline-block"}),renderUsers()}}function renderUsers(){const e=document.getElementById("users-container");if(!e)return;const t=auth.users;0!==t.length?e.innerHTML=t.map(e=>`\n        <div class="resource-item">\n            <div class="item-header">\n                <div class="item-title">${e.FullName}</div>\n                <div class="item-category">${e.Role}</div>\n            </div>\n            <div class="item-details">\n                <div class="item-location">üìç ${e.Barangay}</div>\n                <div><strong>Username:</strong> ${e.Username}</div>\n                ${e.Phone?`<div><strong>Phone:</strong> ${e.Phone}</div>`:""}\n                <small>Registered on ${e.DateRegistered}</small>\n            </div>\n        </div>\n    `).join(""):e.innerHTML='<div class="empty-state">No users found.</div>'}document.addEventListener("click",function(e){const t=document.getElementById("profileDropdown"),r=document.querySelector(".profile-icon");t&&!t.contains(e.target)&&e.target!==r&&t.classList.remove("show")});